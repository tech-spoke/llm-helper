# v1.4 アップデート

Release Date: 2025-01

## 概要

v1.4 では検証が繰り返し失敗した際に「ハマり」状態を打破するリトライベース介入システムを追加。

## 新機能

### 介入システム

LLM が検証失敗を繰り返して「ハマっている」状態を検出し、アプローチの再検討を促します。

**ワークフロー:**
```
検証が3回以上失敗
    ↓
サーバーが failure_history を返却
    ↓
LLM が失敗内容を分析し、介入プロンプトを選択
    ↓
LLM が介入プロンプトを読み、指示に従う
    ↓
変更を revert して別のアプローチを試す
```

**デフォルト介入プロンプト:**

| ファイル | 目的 | 選択の目安 |
|----------|------|-----------|
| `structure_review.md` | 構造見直し | 位置調整を繰り返している |
| `hypothesis_review.md` | 仮説再検討 | エラーメッセージが毎回違う |
| `step_back.md` | 一歩引いて考え直す | 一般的なハマり状態 |
| `user_escalation.md` | ユーザーに相談 | 2回以上介入しても解決しない |

**強制エスカレーション:** 2回介入しても解決しない場合、`user_escalation.md` が必須になります。

**使用例:**
```bash
# 標準モード（介入有効）
/code このバグを修正

# 介入システムをスキップ
/code --no-intervention 簡単なtypo修正
/code -ni 簡単なtypo修正
```

### 最終報告時のプロンプト提案

タスク完了後、LLM がセッションでの経験に基づいて新しいプロンプトを提案します：

**介入プロンプト提案:**
- `intervention_count >= 1` の場合にトリガー
- 新しい `.code-intel/interventions/{pattern}_review.md` を提案

**検証プロンプト提案:**
- `verification_failures >= 2` の場合にトリガー
- `.code-intel/verifiers/{category}.md` への改善を提案

### 新しいコマンドオプション

| Long | Short | 説明 |
|------|-------|------|
| `--no-intervention` | `-ni` | 介入システムをスキップ |

### 設定

`.code-intel/context.yml`:
```yaml
interventions:
  enabled: true
  prompts_dir: "interventions/"
  threshold: 3  # 介入発動までの失敗回数
  force_escalation_after: 2  # N回介入後に強制エスカレーション
  suggest_new_prompts: true  # 最終報告で新プロンプトを提案
  patterns:
    - threshold: 3
      pattern: "css_layout"
      prompts: ["structure_review", "user_escalation"]
    - threshold: 3
      pattern: "filament"
      prompts: ["hypothesis_review", "user_escalation"]
    - threshold: 3
      pattern: "default"
      prompts: ["step_back"]

verifiers:
  suggest_improvements: true  # 最終報告で改善を提案
```

## 破壊的変更

- なし

## バグ修正

- なし
