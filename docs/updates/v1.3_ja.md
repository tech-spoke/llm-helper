# v1.3 アップデート

Release Date: 2025-01

## 概要

v1.3 ではサブエージェントを使用したドキュメント調査フェーズと、マークアップファイルの軽量クロスリファレンス分析を追加。

## 新機能

### DOCUMENT_RESEARCH フェーズ (Step 2.5)

Claude Code の Task ツールを使用して設計ドキュメントを調査する新しいフェーズ。

**2層コンテキストアーキテクチャ:**

| レイヤー | ソース | 目的 |
|---------|--------|------|
| project_rules | CLAUDE.md | 常に必要なベースライン（静的） |
| mandatory_rules | docs/ via サブエージェント | タスク固有の制約（動的） |

**ワークフロー:**
1. サブエージェント（Explore タイプ）が docs/ ディレクトリを読み取り
2. 現在のタスクに関連するルールを抽出
3. `mandatory_rules`, `dependencies`, `warnings` を返却
4. `submit_understanding` でルールを acknowledge 必須

**設定 (`context.yml`):**
```yaml
doc_research:
  enabled: true
  docs_path:
    - "docs/"
  default_prompts:
    - "default.md"
```

**コマンドオプション:**
```
/code --doc-research=security add auth  # 特定プロンプトを使用
/code --no-doc-research fix typo        # 調査をスキップ
```

### マークアップクロスリファレンス分析

緩和マークアップモードでも、CSS/HTML/JS 間のクロスリファレンスを検出。

| 対象 | 検索先 | 検出内容 |
|------|--------|----------|
| CSS/SCSS | HTML ファイル | クラス/ID の使用箇所 |
| HTML | CSS/SCSS ファイル | スタイル定義 |
| HTML | JS/TS ファイル | getElementById, querySelector |

**レスポンス例:**
```json
{
  "mode": "relaxed_markup",
  "static_references": {
    "html_files": [
      {"file": "index.html", "identifier": "btn-primary"}
    ]
  },
  "confirmation_required": {
    "should_verify": ["index.html"]
  }
}
```

### ルール確認

DOCUMENT_RESEARCH が実行された場合、`submit_understanding` には以下が必要:
- `rule_acknowledgment`: 必須ルール ID のリスト
- `rule_compliance_plan`: 各ルールへの準拠方法

### 自動検出

`docs_path` が未設定の場合、以下を自動検出:
1. `docs/` ディレクトリ
2. `DESIGN*.md` ファイル
3. `README.md`（フォールバック）

## 破壊的変更

- context.yml の `essential_docs` は非推奨（代わりに `doc_research` を使用）
- INTERNALS ドキュメントは DESIGN ドキュメントに統合

## コマンドオプション

| Long | Short | 説明 |
|------|-------|------|
| `--doc-research=PROMPTS` | - | 調査プロンプトを指定 |
| `--no-doc-research` | - | ドキュメント調査をスキップ |

## バグ修正

- 修正: `/code` コマンドでタスクブランチパラメータが渡されていなかった問題
- 修正: マークアップ緩和に `.sass` と `.less` 拡張子を追加
