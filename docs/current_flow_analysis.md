# 現在のフロー分析: 起動からREADYまで

## 実測データ（重要な発見）

### ツール実行時間の実測
```bash
# ctags（除外設定あり）
time ctags ... : 6.7秒

# ripgrep
time rg ... : 0.02秒
```

**結論**: ツール自体の実行時間は **7-10秒程度**

### 「10分」の誤解
- 当初の想定: find_definitions 2-3分 + find_references 2-3分 + ... = 7-11分
- **実測**: ツール実行は10秒以下
- **実際のボトルネック**: LLMとの順次往復通信

---

## フロー図

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ユーザーがプロジェクト側で /code を実行                    │
│    "Edit the login button style"                            │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. Claude Code (プロジェクト側) が Skill tool を呼び出し    │
│    skill: "code", args: "Edit the login button style"      │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. code.md のプロンプトが読み込まれる                        │
│    - Step 0-9 の詳細な指示                                  │
│    - Phase gate system の説明                               │
│    - ⚠️ CRITICAL RULES (SURVIVES COMPACTION)               │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. Step 2: start_session                                    │
│    LLM → MCP: mcp__code-intel__start_session               │
│    遅延: ~1秒 (LLM往復)                                      │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. Step 3.5: begin_phase_gate                               │
│    LLM → MCP: mcp__code-intel__begin_phase_gate            │
│    遅延: ~1秒 (LLM往復)                                      │
│    結果: EXPLORATION フェーズに入る                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. Step 4: EXPLORATION フェーズ（ここが遅い）               │
│                                                             │
│    LLM思考: "まずシンボルを探そう"                          │
│      ↓ ~1秒 (LLM処理)                                       │
│    LLM → MCP: find_definitions("login")                    │
│      ↓ 6.7秒 (ctags実行)                                    │
│    MCP → LLM: [結果]                                        │
│      ↓ ~1秒 (LLM処理)                                       │
│    LLM思考: "次に参照を探そう"                              │
│      ↓ ~1秒 (LLM処理)                                       │
│    LLM → MCP: find_references("login")                     │
│      ↓ 0.02秒 (ripgrep実行)                                 │
│    MCP → LLM: [結果]                                        │
│      ↓ ~1秒 (LLM処理)                                       │
│    LLM思考: "さらに検索しよう"                              │
│      ↓ ~1秒 (LLM処理)                                       │
│    LLM → MCP: search_text("button style")                  │
│      ↓ 0.02秒 (ripgrep実行)                                 │
│    MCP → LLM: [結果]                                        │
│      ↓ ~1秒 (LLM処理)                                       │
│    LLM: submit_understanding を呼び出し                      │
│                                                             │
│    **合計**: 約6-8往復 × 1-2秒 = 10-15秒                    │
│    **ツール実行時間**: 6.7秒                                │
│    **LLM往復遅延**: 10-15秒                                 │
│    **フェーズ合計**: 20-25秒                                │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 7. Step 5: SEMANTIC フェーズ（条件付き）                    │
│    semantic_search の実行                                   │
│    遅延: 同様のパターン                                      │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 8. Step 6: VERIFICATION フェーズ（条件付き）                │
│    confirm_symbol_relevance の実行                          │
│    遅延: 同様のパターン                                      │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 9. Step 7: IMPACT_ANALYSIS フェーズ                         │
│    analyze_impact の実行                                    │
│    遅延: 同様のパターン                                      │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 10. Step 9: READY フェーズ                                  │
│     Edit/Write/Bash が使用可能に                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 遅延の内訳

### 典型的なEXPLORATIONフェーズの例

```
時刻    | イベント                        | 累積時間
--------|--------------------------------|----------
0.0s    | begin_phase_gate 完了          | 0s
        | LLM思考中...                   |
1.0s    | find_definitions 開始          | 1s
7.7s    | find_definitions 完了          | 7.7s
        | LLM思考中...                   |
8.7s    | find_references 開始           | 8.7s
8.72s   | find_references 完了           | 8.72s
        | LLM思考中...                   |
9.7s    | search_text 開始               | 9.7s
9.72s   | search_text 完了               | 9.72s
        | LLM思考中...                   |
10.7s   | query 開始                     | 10.7s
10.75s  | query 完了                     | 10.75s
        | LLM思考中...                   |
11.7s   | submit_understanding 開始      | 11.7s
11.75s  | submit_understanding 完了      | 11.75s
```

**合計**:
- ツール実行時間: 6.7s (ctags) + 0.05s (その他) = **6.75秒**
- LLM往復遅延: 5往復 × 1秒 = **5秒**
- **合計**: 約12秒

### 全フェーズ（HIGH gate level）

```
フェーズ              | ツール実行 | LLM往復 | 合計
---------------------|-----------|---------|------
EXPLORATION          | 6.75秒    | 5秒     | ~12秒
SEMANTIC             | 2秒       | 2秒     | ~4秒
VERIFICATION         | 0.5秒     | 2秒     | ~2.5秒
IMPACT_ANALYSIS      | 1秒       | 2秒     | ~3秒
---------------------|-----------|---------|------
合計                 | 10.25秒   | 11秒    | ~21.5秒
```

**重要な発見**: ツール実行時間よりもLLM往復遅延の方が大きい！

---

## ボトルネック分析

### 1. LLMとの順次往復（最大のボトルネック）
```
現在:
  LLM → find_definitions (遅延1秒) → 実行6.7秒 → LLM (遅延1秒)
  LLM → find_references (遅延1秒) → 実行0.02秒 → LLM (遅延1秒)
  ...

問題:
  - 各ツール呼び出しごとに2秒の往復遅延
  - 5-10回の呼び出し = 10-20秒の遅延
```

### 2. 順次実行（並列化されていない）
```
現在:
  find_definitions (6.7秒) → 完了待ち → find_references (0.02秒)

改善可能:
  find_definitions (6.7秒) }
  find_references (0.02秒) } 並列実行 → 6.7秒で完了
```

### 3. ツール実行時間（相対的に小さい）
```
ctags: 6.7秒（最大）
ripgrep: 0.02秒
その他: 0.5-2秒

合計: 約10秒（全体の約50%）
```

---

## 改善案の比較

### 案1: 現状維持（--fast使用を推奨）
```bash
/code --fast "Edit login button"
```
- 効果: EXPLORATION フェーズをスキップ → 0秒でREADY
- 欠点: コード理解がスキップされる
- 実装: 不要（既存機能）

### 案2: 並列ツール呼び出し（LLM側）
```python
# LLMが1メッセージ内で複数ツールを呼び出し
[
  mcp__code-intel__find_definitions("login"),
  mcp__code-intel__find_references("login"),
  mcp__code-intel__search_text("button")
]
```
- 効果: LLM往復遅延を1回に削減（10秒 → 2秒）
- 残る問題: ツールは順次実行される
- 実装: LLMの挙動変更（プロンプト改善）

### 案3: batch_explore ツール（サーバー側並列実行）✅
```python
# 1回のLLM呼び出しで複数タスクを送信
mcp__code-intel__batch_explore({
  "tasks": [
    {"tool": "find_definitions", "args": {"symbol": "login"}},
    {"tool": "find_references", "args": {"symbol": "login"}},
    {"tool": "search_text", "args": {"query": "button style"}}
  ]
})

# サーバー側で並列実行
results = await asyncio.gather(
  find_definitions("login"),      # 6.7秒
  find_references("login"),       # 0.02秒（並列）
  search_text("button style")     # 0.02秒（並列）
)
# → 最大6.7秒で完了

# 1回のレスポンスで全結果を返す
```

**効果の内訳**:
- ツール実行時間: 10秒 → 6.7秒（並列化）
- LLM往復遅延: 10秒 → 2秒（1往復のみ）
- **合計**: 20秒 → **8.7秒**（60%削減）

**追加効果**:
- 2回目以降のセッション: キャッシュ効果でさらに高速化
- semantic_search などもバッチに含められる

---

## Cursorとの比較

### Cursor（常駐型）
```
起動: エディタ起動時に1回のみ
インデックス: メモリ常駐（in-memory）
検索: O(1) ハッシュテーブル
更新: バックグラウンドスレッド

READYまで: 約30秒（初回インデックス構築）
2回目以降: 即座（インデックス更新のみ）
```

### このMCPサーバー（都度起動型）
```
起動: セッション開始ごと
インデックス: ディスクキャッシュ
検索: O(n) ファイルスキャン（部分一致）
更新: 同期実行

READYまで: 約20秒（毎回）
batch_explore後: 約8秒（毎回）
```

### 常駐型への移行（長期案）
```
実装時間: 2-3ヶ月
期待効果: 20秒 → 0.5秒（40倍高速化）

構成:
  - 独立デーモンプロセス
  - Unix socketでRPC通信
  - ファイル監視（inotify/watchdog）
  - インメモリインデックス
```

---

## 次のステップ（batch_explore実装）

### フェーズ1: 設計（今ここ）
- [x] 現在のフロー分析
- [ ] batch_explore のAPI設計
- [ ] エラーハンドリング設計
- [ ] code.md のプロンプト修正

### フェーズ2: 実装（1-2週間）
- [ ] batch_explore ツール実装
- [ ] 並列実行ロジック
- [ ] エラー集約
- [ ] テストケース

### フェーズ3: 統合（1週間）
- [ ] code.md の更新（バッチ呼び出しを推奨）
- [ ] ドキュメント更新
- [ ] パフォーマンス計測

---

## 結論

### 実測による重要な発見
1. **ツール実行時間は7-10秒程度**（「10分」は誤解）
2. **LLM往復遅延が最大のボトルネック**（10-15秒）
3. **並列化の余地あり**（順次実行が遅い）

### 最も効果的な改善
**batch_explore ツール**:
- 1往復で複数ツールを実行
- サーバー側で並列実行
- 20秒 → 8秒（60%削減）
- 実装時間: 1-2週間

### 長期的な改善
**常駐型サーバー**:
- 20秒 → 0.5秒（40倍高速化）
- Cursor並みの体験
- 実装時間: 2-3ヶ月
