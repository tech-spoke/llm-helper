# v1.7/v1.8 最適化の最終まとめ

**注**: この分析は元々v1.7として計画されていましたが、並列実行の検証を優先するため、確実な最適化はv1.8に繰り下げました。このドキュメントはv1.8の分析として参照してください。

## 全フェーズ分析結果

実測データ（session_20260123_160021、合計402秒）を基に全フェーズを分析。

---

## フェーズ別分析結果

| フェーズ | 所要時間 | LLM判断必要 | バッチ化可能 | v1.7削減 | 備考 |
|---------|----------|------------|------------|----------|------|
| **Step 0** | 4-6秒 | ❌ | ✅ | **4-6秒** | 改善サイクルログ無効化（完了） |
| **Step 2-3.5（準備）** | 117秒 | ⚡ 部分的 | ✅ | **5秒** | prepare_session_batch（設計完了） |
| - sync_index | 11.5秒 | ❌ | ❌ | - | ChromaDB同期（削減不可） |
| - DOCUMENT_RESEARCH | 30-40秒 | ❌ | ❌ | - | 別エージェント（統合不可） |
| - LLM思考 | 60秒 | ✅ | ❌ | - | mandatory_rules統合（削減不可） |
| - Step 2,3,3.5間待機 | 5秒 | ❌ | ✅ | **5秒** | バッチ化で削減 |
| **Step 4（EXPLORATION）** | 52秒 | ⚡ 部分的 | ✅ | **20秒** | search_text複数パターン（設計完了） |
| - semantic_search | 1秒 | ❌ | ❌ | - | 実行時間（削減不可） |
| - search_text × 3 | 0.06秒 | ❌ | ✅ | - | 並列実行可能 |
| - 最終統合思考 | 24秒 | ✅ | ❌ | - | 判断必要（削減不可） |
| - 中間待機 | 20秒 | ❌ | ✅ | **20秒** | 複数パターン対応で削減 |
| **Step 5（Symbol Validation）** | 15-22秒 | ✅ | ❌ | - | 条件付き実行（今回未実行） |
| **Step 6（SEMANTIC）** | 25秒 | ✅ | ❌ | - | 仮説生成（削減不可） |
| **Step 7（VERIFICATION）** | 30秒 | ✅ | ❌ | - | 仮説検証（削減不可） |
| **Step 8（IMPACT_ANALYSIS）** | 18秒 | ✅ | ❌ | - | ファイル評価（削減不可） |
| **Step 9（READY）** | 88秒 | ✅ | ❌ | - | 実装フェーズ（削減不可） |
| **Step 10（PRE_COMMIT）** | 24秒 | ✅ | ❌ | - | ゴミ検出（削減不可） |
| **Step 10.5（QUALITY_REVIEW）** | 35秒 | ✅ | ❌ | - | 品質チェック（削減不可） |
| **Step 11（完了）** | 11秒 | ❌ | ❌ | - | マージ処理（削減不可） |
| **合計** | **402秒** | - | - | **29-31秒** | **7-8%削減** |

---

## v1.7 実装内容

### ✅ 完了: 改善サイクルログ無効化（4-6秒削減）

**対象**: Step 0（Failure Check）

**変更内容**:
- `tools/outcome_log.py`: outcomes.jsonl / decisions.jsonl 書き込み無効化
- `code_intel_server.py`: record_decision 呼び出し削除
- `.claude/commands/code.md`: Step 0 セクション無効化

**削減理由**: 機能不全の改善サイクル機能を無効化（LLM往復2-3回分）

---

### 📋 設計完了: 準備フェーズバッチ化（5秒削減）

**対象**: Step 2-3.5（準備フェーズ）

**新ツール**: `prepare_session_batch`

**統合内容**:
```python
prepare_session_batch:
  ├─ sync_index（11.5秒）
  ├─ set_query_frame（3秒、Claude API使用）
  └─ begin_phase_gate（5秒）
```

**削減内容**: Step 2,3,3.5 間の LLM 待機（5秒）

**注意**: DOCUMENT_RESEARCH（30-40秒 + LLM思考60秒）は別エージェントのため統合不可

**設計書**: [docs/draft/preparation_batch_design.md](preparation_batch_design.md)

---

### 📋 設計完了: EXPLORATION並列化（20秒削減）

**対象**: Step 4（EXPLORATION）

**拡張内容**: `search_text` 複数パターン対応

```python
# 現在（逐次実行）
search_text("modal") → 待機11秒 → search_text("background") → 待機9秒 → search_text("overlay")

# 改善後（並列実行）
search_text(patterns=["modal", "background", "overlay"])
  → ThreadPoolExecutor で並列実行
  → 0.06秒で完了
```

**削減内容**: 中間待機（11秒 + 9秒 = 20秒）

**適応性維持**: semantic_search の結果を見てから検索パターンを決定（8秒の思考は削減不可）

---

## 削減不可なフェーズ（LLM判断が必要）

### Step 5: Symbol Validation（15-22秒）

**理由**: 各シンボルの承認/却下判断 + code_evidence 記述が必要

**内容**:
- cached_matches と embedding_suggestions を分析
- 各シンボルが target_feature に関連するか判断
- 承認する場合、具体的な証拠を記述

**バッチ化不可**: validate と confirm の間に10-15秒のLLM判断が必要

---

### Step 6: SEMANTIC（25秒）

**理由**: 仮説生成は高度な推論が必要

**内容**:
- EXPLORATION 結果から不足情報を特定
- 仮説（hypotheses）を生成（confidence付き）
- semantic_reason 決定（no_similar_implementation / isolated_usage 等）

**バッチ化不可**: 単一ツール呼び出しのため、そもそもバッチ化の余地なし

---

### Step 7: VERIFICATION（30秒）

**理由**: 仮説とコードの照合は慎重な確認が必要

**内容**:
- SEMANTIC で生成した仮説をコードで検証
- エビデンス（found_clues）収集：コード断片、ファイルパス、行番号
- 検証結果のまとめ

**バッチ化不可**: 単一ツール呼び出しのため、そもそもバッチ化の余地なし

---

### Step 8: IMPACT_ANALYSIS（18秒）

**理由**: analyze_impact の結果を見て、各ファイルを個別評価が必要

**内容**:
```
analyze_impact
  ↓ must_verify: ["CartService.php", "ProductTest.php"]
  ↓ [7秒: LLM判断 - 必須]
  ↓   - CartService.php → will_modify
  ↓   - ProductTest.php → no_change_needed (reason: "Test uses mock data")
submit_impact_analysis
  verified_files: [...]
```

**バッチ化不可**: analyze の結果を見て判断が必要（7秒は削減不可）

**削減可能な部分**: VERIFICATION → IMPACT_ANALYSIS 間の待機（10秒）
- v1.8以降で検討（VERIFICATION + IMPACT統合）

---

### Step 9: READY（88秒）

**理由**: 実装フェーズ、コード変更作業

**内容**: Edit/Write/Bash ツールを使った実装作業

**最適化不可**: 本質的な作業時間

---

### Step 10-10.5: PRE_COMMIT + QUALITY_REVIEW（59秒）

**理由**: 各ファイルの keep/discard 判断と品質チェックが必要

**内容**:
- review_changes（16秒）: 各ファイルを確認、keep/discard 判断
- quality_review（25秒）: 品質チェック（unused imports, CLAUDE.md違反等）

**バッチ化不可**: 判断が必要

**順序問題**: 現在は「ゴミ取り → コミット → 品質チェック」だが、理想は「ゴミ取り → 品質チェック → コミット」
- v1.8以降で検討（Git履歴クリーン化）
- 削減効果: 2-3秒（finalize → quality 間の待機）

---

## v1.7 削減見込みサマリー

| 施策 | 削減時間 | 実装難易度 | 状態 |
|------|----------|------------|------|
| 改善サイクルログ無効化 | 4-6秒 | 低 | ✅ 完了 |
| 準備フェーズバッチ化 | 5秒 | 中 | 📋 設計完了 |
| EXPLORATION並列化 | 20秒 | 低 | 📋 設計完了 |
| **合計** | **29-31秒** | - | - |

**現在**: 402秒（6分42秒）
**改善後**: 371-373秒（6分11-13秒）
**削減率**: 7-8%

---

## v1.8以降の検討事項

### 中優先度

1. **PRE_COMMIT + QUALITY_REVIEW 順序変更**
   - 削減: 2-3秒（統合時の待機のみ）
   - 主な効果: Git履歴クリーン化（コミット数削減）
   - [詳細](pre_commit_quality_order_issue.md)

2. **VERIFICATION + IMPACT_ANALYSIS 統合**
   - 削減: 10秒（VERIFICATION → IMPACT間の待機）
   - リスク: 中（VERIFICATION処理の複雑化）
   - [詳細](impact_analysis_phase.md#推奨実装)

3. **sync_index 高速化**
   - Embedding バッチ処理
   - 削減見込み: 3-5秒
   - [詳細](preparation_phase_detailed_analysis.md#sync_index-の詳細)

### 低優先度

1. **DOCUMENT_RESEARCH の選択的実行**
   - mandatory_rules が既知の場合スキップ
   - 削減見込み: 30-40秒（適用時）
   - リスク: 高（情報不足のリスク）

2. **Symbol Validation の cached_matches 自動承認**
   - 削減: 3-5秒（cached が多い場合）
   - [詳細](symbol_validation_analysis.md#⚡-中優先度検討の価値あり)

---

## 削減不可な部分（LLM判断が必須）

| フェーズ | 所要時間 | 理由 |
|---------|----------|------|
| DOCUMENT_RESEARCH 後の思考 | 60秒 | mandatory_rules との統合判断 |
| EXPLORATION 最終統合 | 24秒 | 全検索結果の統合と評価 |
| Symbol Validation | 10-15秒 | シンボル個別評価と証拠記述 |
| SEMANTIC | 25秒 | 仮説生成（高度な推論） |
| VERIFICATION | 30秒 | 仮説とコードの照合 |
| IMPACT_ANALYSIS | 7秒 | ファイル影響評価 |
| PRE_COMMIT | 16秒 | keep/discard 判断 |
| QUALITY_REVIEW | 25秒 | 品質チェック |
| **合計** | **約197-202秒** | **全体の49-50%** |

**重要な発見**: 全体の約50%はLLM判断が必要な部分であり、削減不可。

---

## バッチ化の原則

### バッチ化可能（v1.7で実装）

1. **固定順序の処理**
   - sync_index → set_query_frame → begin_phase_gate
   - 順序が決まっており、判断不要

2. **独立した並列処理**
   - search_text 複数パターン
   - 各検索は独立しており、並列実行可能

### バッチ化不可（LLM判断が必要）

1. **結果を見て判断する処理**
   - validate → [判断] → confirm
   - analyze → [判断] → submit

2. **高度な推論が必要な処理**
   - 仮説生成（SEMANTIC）
   - 仮説検証（VERIFICATION）
   - コード品質評価（QUALITY_REVIEW）

---

## 実装優先度

### v1.7（実装中）

1. ✅ 改善サイクルログ無効化（完了）
2. 🚧 prepare_session_batch（設計完了、実装時間: 5.5-6.5時間）
3. 🚧 search_text 複数パターン（設計完了、実装時間: 2-3時間）

**Total実装時間**: 7.5-9.5時間

### v1.8（検討）

1. PRE_COMMIT + QUALITY_REVIEW 順序変更（3-4時間）
2. VERIFICATION + IMPACT_ANALYSIS 統合（4-5時間）
3. sync_index 高速化（6-8時間）

### v1.9以降（検討）

1. DOCUMENT_RESEARCH 選択的実行
2. Symbol Validation 自動承認

---

## まとめ

### v1.7 の成果

- **削減**: 29-31秒（7-8%）
- **アプローチ**: LLM判断不要な部分のバッチ化と並列化
- **設計原則**: 適応性を維持しつつ速度向上

### 削減の限界

- **LLM判断必須部分**: 約50%（削減不可）
- **これ以上の削減**: フローの根本的な見直しが必要
- **v1.8以降**: 10-15秒の追加削減可能性

### 重要な教訓

1. **バッチ化は万能ではない**: LLM判断が必要な部分は削減不可
2. **適応性とのトレードオフ**: 完全な事前計画は適応性を犠牲にする
3. **50%の壁**: LLM判断が必要な部分が約半分を占める

次: v1.7 実装作業へ
