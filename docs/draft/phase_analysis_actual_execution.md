# フェーズ分析: 実際の実行記録から

## 実行記録データ

- **セッションID**: session_20260123_160021
- **総実行時間**: 約402秒（6分42秒）
- **ツール呼び出し**: 20回
- **ツール実行時間**: 約110秒（27%）
- **LLM思考時間**: 約292秒（73%）

---

## フェーズごとの詳細

### 準備フェーズ（Step 1-3.5）

**所要時間**: 約109秒（sync_indexが大半）
**ツール呼び出し**: 3回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 1 | sync_index | 16:00:43 → 16:02:32 | 109秒 | ChromaDB同期 |
| 2 | set_query_frame | 16:02:32 | - | クエリ構造化 |
| 3 | begin_phase_gate | 16:02:40 | - | ブランチ作成、フェーズ開始 |

**バッチ化の可能性**: ⭐⭐⭐
LLM思考不要。順序固定、パラメータ決定済み。

---

### EXPLORATIONフェーズ（Step 4）

**所要時間**: 約60秒
**ツール呼び出し**: 5回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 4 | semantic_search | 16:02:48 | - | ベクトル検索 |
| 5 | search_text | 16:02:56 | 0.023秒 | 1 matches |
| 6 | search_text | 16:03:07 | 0.024秒 | 10 matches |
| 7 | search_text | 16:03:16 | 0.011秒 | 29 matches |
| 8 | submit_understanding | 16:03:40 | - | EXPLORATION完了 |

**内訳**:
- ツール実行: 0.058秒
- LLM思考: 約60秒（4往復 × 15秒）

**バッチ化の可能性**: ⭐⭐
semantic_search + 複数の search_text パターンを並列実行可能。
ただし、submit_understanding のタイミングはLLM判断が必要。

---

### SEMANTICフェーズ（Step 6）

**所要時間**: 約25秒
**ツール呼び出し**: 2回（1回失敗リトライ）

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 9 | submit_semantic | 16:03:53 | - | 失敗（reason不適切） |
| 10 | submit_semantic | 16:04:05 | - | 成功 |

**内訳**:
- ツール実行: < 0.1秒
- LLM思考: 約25秒（リトライ含む）

**バッチ化の可能性**: ❌
LLM判断が必要（仮説生成 + 理由検証）

---

### VERIFICATIONフェーズ（Step 7）

**所要時間**: 約30秒
**ツール呼び出し**: 1回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 11 | submit_verification | 16:04:35 | - | 仮説検証完了 |

**内訳**:
- ツール実行: < 0.1秒
- LLM思考: 約30秒（コード確認 + エビデンス収集）

**バッチ化の可能性**: ❌
LLM判断が必要（仮説とコードの照合）

---

### IMPACT_ANALYSISフェーズ（Step 8）

**所要時間**: 約18秒
**ツール呼び出し**: 2回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 12 | analyze_impact | 16:04:45 | - | 影響分析実行 |
| 13 | submit_impact_analysis | 16:04:53 | - | 影響確認完了 |

**内訳**:
- ツール実行: < 1秒
- LLM思考: 約17秒

**バッチ化の可能性**: ⭐
analyze_impact の結果確認は必要だが、簡略化の余地あり。

---

### READYフェーズ（Step 9）

**所要時間**: 約88秒
**ツール呼び出し**: 2回（+ Edit/Bash は記録外）

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 14 | check_write_target | 16:04:58 | - | 書き込み可能確認 |
| - | Edit/Bash | - | 推測30-40秒 | ファイル編集、ビルド、確認 |
| 15 | submit_for_review | 16:06:26 | - | 実装完了 |

**内訳**:
- ツール実行（code-intel）: < 0.1秒
- Edit/Bash実行: 30-40秒（推測）
- LLM思考: 約50秒

**バッチ化の可能性**: ❌
実装内容はLLM判断が必要。

---

### PRE_COMMITフェーズ（Step 10）

**所要時間**: 約24秒
**ツール呼び出し**: 2回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 16 | review_changes | 16:06:33 | - | 変更内容レビュー |
| 17 | finalize_changes | 16:06:49 | - | コミット実行 |

**内訳**:
- ツール実行: < 1秒
- LLM思考: 約23秒

**バッチ化の可能性**: ⭐
review結果の確認は必要だが、自動化の余地あり。

---

### QUALITY_REVIEWフェーズ（Step 10.5）

**所要時間**: 約35秒
**ツール呼び出し**: 1回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 18 | submit_quality_review | 16:07:14 | - | 品質レビュー完了 |

**内訳**:
- ツール実行: < 0.1秒
- LLM思考: 約35秒（品質チェック）

**バッチ化の可能性**: ❌
品質判断はLLMが必要。

---

### 完了フェーズ（Step 11）

**所要時間**: 約11秒
**ツール呼び出し**: 2回

| # | ツール | 時刻 | 所要時間 | 説明 |
|---|--------|------|----------|------|
| 19 | merge_to_base | 16:07:25 | - | ブランチマージ |
| 20 | record_outcome | 16:07:36 | - | 結果記録（今後削除） |

**内訳**:
- ツール実行: < 1秒
- LLM思考: 約10秒

**バッチ化の可能性**: ⭐
record_outcome は削除予定。

---

## バッチ化の優先度

### 🔥 高優先度（実装効果大）

#### 1. 準備フェーズのバッチ化

```python
# 現在: 3往復（2回のLLM待機 = 4-6秒）
sync_index → wait → set_query_frame → wait → begin_phase_gate

# 改善案: 1ツールで実行
prepare_session(query, gate_level, intent)
  └─ 内部で sync + query_frame + phase_gate を順次実行
  └─ 1往復で完了

削減: 2往復 ≒ 4-6秒
```

#### 2. EXPLORATIONフェーズの部分バッチ化

```python
# 現在: semantic_search → wait → search_text × 3回
# 改善案: 並列実行
batch_explore(query, semantic=True, search_patterns=["modal", "background", "overlay"])
  └─ 並列で semantic_search + search_text × N
  └─ 全結果を1回で返却

削減: 3往復 ≒ 6-9秒
```

---

### ⚡ 中優先度（検討の価値あり）

#### 3. IMPACT_ANALYSIS の簡略化

```python
# analyze_impact + submit_impact_analysis を統合
# 自動で must_verify ファイルを検証
auto_impact_analysis(target_files, change_description)
  └─ 影響分析 + 自動検証 + submit を1ツールで

削減: 1往復 ≒ 2-3秒
```

---

### 💡 低優先度（効果は限定的）

#### 4. PRE_COMMITの簡略化
- review + finalize の統合
- 削減: 1往復 ≒ 2-3秒

---

## 合計削減見込み

| 施策 | 削減時間 | 実装難易度 |
|------|----------|------------|
| 準備フェーズバッチ化 | 4-6秒 | 低 |
| EXPLORATION部分バッチ化 | 6-9秒 | 中 |
| IMPACT_ANALYSIS簡略化 | 2-3秒 | 低 |
| PRE_COMMIT簡略化 | 2-3秒 | 低 |
| record_outcome削除 | 2-3秒 | 完了済み |
| **合計** | **16-24秒** | - |

**現在**: 約400秒
**改善後**: 約380秒（5%削減）

---

## 重要な発見

### 本当のボトルネック

1. **sync_index**: 109秒（27%）← これが最大のボトルネック
2. **LLM思考時間**: 292秒（73%）
3. **ツール実行時間（sync除く）**: 1秒未満

### 結論

**バッチ化で削減できるのは、全体の4-6%程度。**

**根本的な高速化には:**
- sync_index の高速化（キャッシュ改善、増分更新）
- LLM思考そのものの削減（より単純なフロー）

が必要。

---

## 次のアクション

1. ✅ record_outcome削除（完了）
2. 🔥 準備フェーズバッチ化（prepare_session ツール作成）
3. 🔥 EXPLORATION部分バッチ化（batch_explore ツール作成）
4. 📊 sync_index の高速化検討（別途）
